# ElastiCache

> ElastiCache 구성을 위해 기재하였습니다. 자세한 내용은 추후 공부하여 추가할 예정입니다 :)

Elastic Cache는 클라우드에서 ValKey, Memcached, Redis OSS 프로토콜 준수 캐시의 배포 및 실행을 간소화하는 웹 서비스이다.  
주로 속도가 느린 디스크 기반 시스템에 의존하기보다, 메모리 시스템에서 정보를 검색할 수 있도록하여 애플리케이션 성능을 향상시킨다.

## 사용 목적

1. 캐시 서버를 사용하여, 검색엔진(ES)의 부하를 줄이기 위한 목적으로 사용
2. 기술 선택의 경우 Valkey를 사용하였으며, 기존 Redis와 호환이 되고 자동 장애복구 등의 이유로 선택 하였다

## ElastiCache 엔진 비교

| **기능/특성**         | **Valkey (AWS Managed)**                                              | **Redis OSS (AWS Managed)**                                           | **Memcached (AWS Managed)**                           | **Redis (EC2 직접 설치)**                                             |
| --------------------- | --------------------------------------------------------------------- | --------------------------------------------------------------------- | ----------------------------------------------------- | --------------------------------------------------------------------- |
| **사용 라이선스**     | BSD 3-Clause (상업적 사용에 제한 없음)                                | RSAL/SSPL (하단 추가설명 참고)                                        | BSD (하단 추가설명 참고)                              | BSD (하단 추가설명 참고)                                              |
| **데이터 영속성**     | 지원 (유지)                                                           | 지원 (옵션)                                                           | 미지원                                                | 지원                                                                  |
| **고가용성**          | 클러스터링 지원 (데이터 분산 및 자동 복제 수행) + 자동 장애 복구 지원 | 클러스터링 지원 (데이터 분산 및 자동 복제 수행) + 자동 장애 복구 지원 | 클러스터링 지원 X + 자동 장애 복구 지원 X             | 클러스터링 지원 (데이터 분산 및 자동 복제 수행) + 자동 장애 복구 지원 |
| **확장성**            | 자동 샤딩 지원 (자동 데이터 분배 및 재배치)                           | 자동 샤딩 지원 (자동 데이터 분배 및 재배치)                           | 수동 샤딩 (애플리케이션에서 직접 샤딩 로직 구현 필요) | 수동 샤딩                                                             |
| **보안 기능**         | AWS IAM, 데이터 암호화, 인증                                          | AWS IAM, 기본 보안                                                    | AWS IAM, 기본 보안                                    | 보안 그룹 설정 및 추가적인 보안 설정 필요                             |
| **복제 및 장애 복구** | 자동화된 복제 및, 장애 복구 지원                                      | 수동 구성 가능                                                        | 지원하지 않음                                         | 수동 구성 필요                                                        |
| **운영 비용**         | Redis OSS, Memcached에 비해 시간당 요금 저렴                          | 고비용 (관리형 서비스)                                                | 상대적으로 저렴                                       | 초기 설정 비용 있지만 낮은 운영 비용                                  |
| **유지보수**          | AWS 관리 (자동화)                                                     | AWS 관리 (자동화)                                                     | AWS 관리 (자동화)                                     | 사용자 직접 유지보수 필요                                             |
| **사용 예시**         | 고성능 및 보안이 필요한 애플리케이션                                  | 실시간 데이터 처리, 캐싱 등                                           | 웹 애플리케이션 캐싱                                  | 세션 관리, 고성능 실시간 데이터 처리                                  |
| **호환성**            | Redis와 호환 가능 (하위호환 지원)                                     | 널리 호환됨                                                           | 널리 호환됨                                           | 널리 호환됨                                                           |

## ElastiCache 구성 순서

- ElasticCache > Valkey 캐시 > Valkey 캐시 생성 이동
  - 배포 옵션
    - 서버리스 - 신규
      - 서버 관리 없이 자동으로 확장되는 캐시를 빠르게 생성하는 옵션
      - 애플리케이션 트래픽에 맞게 자동으로 조정
    - `자체 캐시 설계`
      - `사용자가 직접` `노드 유형`, `크기`, `개수` 선택 및 `캐시 생성하는 옵션`
      - 맞춤형 구성 필요할 때 사용
  - 생성 방법
    - `클러스터 캐시 선택`
  - 클러스터 모드
    - 클러스터 모드 활성화 여부 선택
    - 활성화
      - 확장성 및 가용성 개선을 위해, 여러 샤드에 데이터 복제 및 파티셔닝 지원
      - 최대 500개의 노드 그룹 사용 가능
      - 대규모 분산 처리 필요할 때 적합
    - `비활성화`
      - `단일 샤드로 동작, 간단한 캐싱에 적합`
  - 클러스터 정보
    - 이름 및 설명
      - 캐시 이름 및 설정
  - 위치
    - AWS 클라우드 설정
    - 다중 AZ
      - 사용 설정
  - 클러스터 설정
    - 엔진 버전
      - 7.2
    - 포트
      - Redis 포트 지정 - 6379
    - 파라미터 그룹
      - default.valkey8
    - 노드 유형
      - `클러스터`에서 `사용할 노드`의 `크기 및 스펙 선택`
        - `cache.r7g.large`
    - 복제본 개수
      - 가용성을 높이기 위해, 복제본 노드의 개수 지정
      - `2개 지정`
  - 연결
    - 네트워킹 유형: IPv4
    - 서브넷 그룹
      - 새 서브넷 그룹 생성
      - `Subnet을 신규로 만드는게 아니라, 기존에 있는 서브넷을 그룹으로 묶는 부분`
    - 이름 및 설명
      - 서브넷 그룹 이름 지정
    - VPC ID
      - `기존에 사용하는 VPC 지정`
    - 서브넷 선택
      - `Private Zone 서브넷 대역 선택`
    - 서브넷 그룹에 대한 태그
      - 태그 추가
  - 가용 영역 배치
    - `ap-northeast-2a`
    - `ap-northeast-2b`
    - `ap-northeast-2c`
  - 고급설정
    - 보안
      - 저장 중 암호화
        - 미사용
      - 암호화 키
        - AWS 제공 기본 키
      - 전송 중 암호화
        - 미사용
      - 엑세스 제어
        - `없음`
      - 보안 그룹 선택됨
        - 보안 그룹 지정
        - 인바운드 6379 포트 열어야 함
        - 출발지에서는 아웃바운드 6379 포트 열어야함
      - 자동 백업 사용
        - 비활성화
      - 백업 보존 기간
        - 비활성화
      - 백업 창
        - 비활성화

## EC2 -> AWS ElastiCache 접속

EC2에 구동되고 있는 모든 서비스는 Private Subnet 대역에 구동중이다.  
RoutingTable + NAT를 통해 외부로 나가는 네트워크는 없기에 Public Zone EC2에서  
redis-stable.tar.gz 파일을 다운로드 후 Private 대역으로 전달해주려고 한다.

또한 접근하고자 하는 출발지(EC2)의 `아웃바운드는 6379`(redis port) 요청이 가능해야 하며,  
AWS ElastiCache의 보안그룹에서도 `인바운드로 6379`(출발지 EC2)가 등록이 되어 있어야 통신이 가능하다.

```shell
# Public EC2에서 redis-stable.tar.gz 다운로드 -> Private EC2에 SCP 통해 파일 전달
scp -i ./xxx.pem ./redis-stable.tar.gz ec2-user@172.xx.xx.xx:/home/ec2-user
```

```shell
# make(빌드 자동화 툴) 하기 위한 gcc(GNU Compiler Collection) 컴파일러 다운로드
# make는 빌드를 수행하기 위해 사용되는 커멘드이다
# gcc는 컴파일을 통해 특정 소스코드를 -> 바이너리 파일로 변환하기 위한 컴파일러
sudo yum install -y gcc
```

`gcc 패키지`는 `C/C++ 프로그램`을 `컴파일`하는데 `사용`되는 기본 컴파일러이다.  
또한 `gcc 컴파일러`를 통해 `다양한 프로그램 언어로 작성된 소스 코드`를 `Binary File`로 `컴파일` 하기 위해 `사용`한다.  

```shell
# redis-cli 설치 및 make
wget http://download.redis.io/redis-stable.tar.gz && tar xvzf redis-stable.tar.gz && cd redis-stable && make
```

위 명령어를 통해 redis-stable.tar.gz 다운로드 후 tar 압축 해제 후 make 명령어를 통해 빌드 작업을 진행한다.  
이전에 gcc 패키지를 받아두었기 때문에 빌드하는데 큰 무리는 없는 것으로 보인다.

```shell
# redis-cli를 bin에 추가해 어느 위치서든 사용 가능하게 등록
sudo cp src/redis-cli /usr/bin/
```

후에 모든 설치가 완료되면 redis-cli 실행 파일을 /usr/bin/ 경로에 위치시키고,  
이제 어디서든 redis-cli 실행이 가능한 상태가 된다.

```shell
# AWS ElastiCache 기본 엔드포인트
redis-cli -h <엔드포인트>
```

위 명령어를 통해 이제 redis에 접속을 시도한다.

## 참고 자료

- [EC2에 Redis CLI 설치하기](https://jojoldu.tistory.com/348)
- [[Spring/ Redis] Spring으로 ElasticCache for Redis 사용해보기](https://loosie.tistory.com/814)